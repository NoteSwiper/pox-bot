import json
import random
import time
import discord
from discord.ext import commands, tasks
from discord import Activity, ActivityType, CustomActivity, Embed, Interaction, InteractionType, Message, Status, app_commands

import aiofiles

from bot import PoxBot
import data
from logger import logger

class InactivityStatus(commands.Cog):
    def __init__(self, bot):
        self.bot: PoxBot = bot

        self.PRIMARY_INACTIVITY_THRESHOLD = 60 * 2.5
        self.SECONDARY_INACTIVITY_THRESHOLD = 60 * 1
        self.FINAL_INACTIVITY_THRESHOLD = 60 * 5

        self.last_activity_time = time.time()

        self.current_state = 0

        self.inactivity_enabled = False

        self.status_check_loop.start()
    
    async def cog_unload(self):
        self.status_check_loop.cancel()
    
    @commands.Cog.listener()
    async def on_message(self, message: Message):
        if message.author.id == self.bot.user.id: return

        self.last_activity_time = time.time()

        if self.current_state != 0:
            await self._set_active_status()
    
    @commands.Cog.listener()
    async def on_interaction(self, interaction: Interaction):
        if interaction.type == InteractionType.application_command:
            self.last_activity_time = time.time()

            if self.current_state != 0:
                await self._set_active_status()
    
    async def _set_active_status(self):
        await self.bot.change_presence(
            status=Status.online,
            activity=CustomActivity(name=random.choice(data.emoticons))
        )
        self.current_state = 0
    
    async def _set_secondary_status(self):
        await self.bot.change_presence(
            status=Status.idle,
            activity=CustomActivity(name="...")
        )
        self.current_state = 1
    
    async def _set_primary_status(self):
        await self.bot.change_presence(
            status=Status.idle,
            activity=CustomActivity(name="inactive.",emoji="ðŸ˜«")
        )
        self.current_state = 2
    
    async def _set_final_status(self):
        await self.bot.change_presence(
            status=Status.dnd,
            activity=CustomActivity(name="zzz...",emoji="ðŸ’¤")
        )
        self.current_state = 3
    
    @tasks.loop(seconds=30.0)
    async def status_check_loop(self):
        await self.bot.wait_until_ready()

        elapsed_time = time.time() - self.last_activity_time

        if elapsed_time >= self.FINAL_INACTIVITY_THRESHOLD:
            if self.current_state < 3:
                await self._set_final_status()
        elif elapsed_time >= self.PRIMARY_INACTIVITY_THRESHOLD:
            if self.current_state < 2:
                await self._set_primary_status()
        elif elapsed_time >= self.SECONDARY_INACTIVITY_THRESHOLD:
            if self.current_state < 1:
                await self._set_secondary_status()
        elif self.current_state != 0:
            await self._set_active_status()
    
    @status_check_loop.before_loop
    async def before_status_check_loop(self):
        await self.bot.wait_until_ready()
        await self._set_active_status()

async def setup(bot):
    await bot.add_cog(InactivityStatus(bot))